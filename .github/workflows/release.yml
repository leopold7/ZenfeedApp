# GitHub Actions 工作流：基于 gradle.properties 的全自动 Release
name: Create GitHub Release

on:
  push:
    branches:
      - master # 当向 master 分支推送代码时触发
      - dev    # 当向 dev 分支推送代码时触发

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    # 为工作流授予向仓库写入内容的权限，以便能推送 Git 标签
    permissions:
      contents: write
    env:
      TZ: Asia/Shanghai # 设置时区为东八区
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # 拉取所有历史记录，以便能正确生成更新日志
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Decode Keystore and write to file
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE }}" | base64 --decode > ${{ github.workspace }}/app/mykey

      - name: Create local.properties file
        run: |
          echo "keystore.file=${{ github.workspace }}/app/mykey" >> local.properties
          echo "keystore.password=${{ secrets.RELEASE_KEYSTORE_PASSWORD }}" >> local.properties
          echo "key.alias=${{ secrets.RELEASE_KEY_ALIAS }}" >> local.properties
          echo "key.password=${{ secrets.RELEASE_KEY_PASSWORD }}" >> local.properties

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Determine branch and version information
        id: branch_info
        run: |
          # 获取当前分支
          current_branch=$(echo "${{ github.ref }}" | sed 's|refs/heads/||')
          echo "current_branch=$current_branch" >> $GITHUB_OUTPUT
          
          # 读取版本名称
          versionName=$(grep 'appVersionName' gradle.properties | cut -d'=' -f2)
          echo "base_version=$versionName" >> $GITHUB_OUTPUT
          
          # 生成时间戳
          timestamp=$(date +'%Y%m%d%H%M%S')
          echo "timestamp=$timestamp" >> $GITHUB_OUTPUT
          
          # 为dev分支生成特殊版本号
          if [ "$current_branch" = "dev" ]; then
            dev_version="${versionName}.dev.${timestamp}"
            echo "final_version=$dev_version" >> $GITHUB_OUTPUT
            echo "is_dev=true" >> $GITHUB_OUTPUT
          else
            echo "final_version=$versionName" >> $GITHUB_OUTPUT
            echo "is_dev=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.branch_info.outputs.final_version }}" >/dev/null 2>&1; then
            echo "Tag v${{ steps.branch_info.outputs.final_version }} already exists. No new release needed."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Tag v${{ steps.branch_info.outputs.final_version }} does not exist. Proceeding with release."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Update gradle.properties for dev branch
        # 仅在dev分支且标签不存在时执行
        if: steps.check_tag.outputs.skip == 'false' && steps.branch_info.outputs.is_dev == 'true'
        run: |
          # 更新 gradle.properties 文件中的 appVersionName 为新的 dev 版本号
          new_version="${{ steps.branch_info.outputs.final_version }}"
          echo "Updating gradle.properties with version: $new_version"
          # 使用 sed 命令更新 appVersionName
          sed -i "s/^appVersionName=.*/appVersionName=$new_version/" gradle.properties
          
          # 显示更新后的文件内容
          echo "Updated gradle.properties:"
          cat gradle.properties | grep appVersionName

      - name: Build with Gradle
        # 仅在标签不存在时执行
        if: steps.check_tag.outputs.skip == 'false'
        run: ./gradlew assembleRelease

      - name: Generate Changelog
        # 仅在标签不存在时执行
        if: steps.check_tag.outputs.skip == 'false'
        id: changelog
        run: |
          # 查找上一个版本的标签
          if [ "${{ steps.branch_info.outputs.is_dev }}" = "true" ]; then
            # dev分支：查找最新的稳定版本标签（不以 dev 结尾）
            latest_tag=$(git tag -l "v*" --sort=-version:refname | grep -v "dev" | head -n 1)
          else
            # 稳定分支：查找最新的标签
            latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          fi
          
          if [ -z "$latest_tag" ]; then
            # 如果没有上一个标签，就从第一次提交开始计算
            changelog_content=$(git log --pretty=format:"* %h %s")
          else
            # 如果有上一个标签，就计算两个标签之间的提交
            changelog_content=$(git log ${latest_tag}..HEAD --pretty=format:"* %h %s")
          fi
          # 添加 Full Changelog 链接
          if [ -n "$latest_tag" ]; then
            changelog_content="${changelog_content}"$'\n'$'\n'"**Full Changelog**: https://github.com/${{ github.repository }}/compare/${latest_tag}...v${{ steps.branch_info.outputs.final_version }}"
          fi
          # 将处理后的内容写入 GITHUB_OUTPUT
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$changelog_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Delete old dev releases
        # 仅在dev分支且标签不存在时执行
        if: steps.check_tag.outputs.skip == 'false' && steps.branch_info.outputs.is_dev == 'true'
        run: |
          # 获取所有发布版本
          releases=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/releases)
          
          # 过滤出dev版本并删除
          echo "$releases" | jq -r '.[] | select(.tag_name | test("dev")) | .id' | while read -r release_id; do
            echo "Deleting old dev release: $release_id"
            curl -s -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/releases/$release_id
          done

      - name: Delete old dev tags
        # 仅在dev分支且标签不存在时执行
        if: steps.check_tag.outputs.skip == 'false' && steps.branch_info.outputs.is_dev == 'true'
        run: |
          # 列出所有包含 "dev" 的标签
          dev_tags=$(git tag -l "*dev*")
          
          # 遍历并删除这些标签
          if [ -n "$dev_tags" ]; then
            echo "Deleting old dev tags:"
            echo "$dev_tags" | while read -r tag; do
              echo "Deleting tag: $tag"
              git tag -d "$tag"
              git push origin --delete "$tag"
            done
          else
            echo "No dev tags found to delete"
          fi

      - name: Create Git Tag and Release
        # 仅在标签不存在时执行
        if: steps.check_tag.outputs.skip == 'false'
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: app/build/outputs/apk/release/app-release.apk
          # 使用我们生成的更新日志作为 Release 的 body
          body: ${{ steps.changelog.outputs.changelog }}
          # 使用我们生成的版本号来创建 Release 和 Tag
          tag_name: "v${{ steps.branch_info.outputs.final_version }}"
          name: "Release v${{ steps.branch_info.outputs.final_version }}"
          # 为dev分支设置为预发布
          prerelease: ${{ steps.branch_info.outputs.is_dev == 'true' }}