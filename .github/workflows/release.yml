# GitHub Actions 工作流：master 分支自动 Release
name: Create GitHub Release

on:
  push:
    branches:
      - master # 当向 master 分支推送代码时触发

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    # 为工作流授予向仓库写入内容的权限，以便能推送 Git 标签
    permissions:
      contents: write
    env:
      TZ: Asia/Shanghai # 设置时区为东八区
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # 拉取所有历史记录，以便能正确生成更新日志
        with:
          fetch-depth: 0
          ref: master

      - name: Show Git info
        run: |
          echo "=== Current branch ==="
          git branch --show-current
          echo ""
          echo "=== Current commit ==="
          git rev-parse HEAD
          echo ""
          echo "=== Latest commits on master ==="
          git log master --oneline -5
          echo ""
          echo "=== Remote branches ==="
          git branch -r

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Decode Keystore and write to file
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE }}" | base64 --decode > ${{ github.workspace }}/app/mykey

      - name: Create local.properties file
        run: |
          echo "keystore.file=${{ github.workspace }}/app/mykey" >> local.properties
          echo "keystore.password=${{ secrets.RELEASE_KEYSTORE_PASSWORD }}" >> local.properties
          echo "key.alias=${{ secrets.RELEASE_KEY_ALIAS }}" >> local.properties
          echo "key.password=${{ secrets.RELEASE_KEY_PASSWORD }}" >> local.properties

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Determine version information
        id: branch_info
        run: |
          # 读取版本名称
          versionName=$(grep 'appVersionName' gradle.properties | cut -d'=' -f2)
          echo "final_version=$versionName" >> $GITHUB_OUTPUT

      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.branch_info.outputs.final_version }}" >/dev/null 2>&1; then
            echo "Tag v${{ steps.branch_info.outputs.final_version }} already exists. No new release needed."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Tag v${{ steps.branch_info.outputs.final_version }} does not exist. Proceeding with release."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Changelog
        # 仅在标签不存在时执行
        if: steps.check_tag.outputs.skip == 'false'
        id: changelog
        run: |
          # 查找最新的稳定版本标签（不含 dev）
          latest_tag=$(git tag -l "v*" --sort=-version:refname | grep -v "dev" | head -n 1)
          
          if [ -z "$latest_tag" ]; then
            # 如果没有上一个标签，就从第一次提交开始计算
            changelog_content=$(git log --grep="^feat\|^fix\|^style\|^refactor" --pretty=format:"* %h %s")
          else
            # 如果有上一个标签，就计算两个标签之间的提交
            changelog_content=$(git log ${latest_tag}..HEAD --grep="^feat\|^fix\|^style\|^refactor" --pretty=format:"* %h %s")
          fi
          # 添加 Full Changelog 链接
          if [ -n "$latest_tag" ]; then
            changelog_content="${changelog_content}"$'\n'$'\n'"**Full Changelog**: https://github.com/${{ github.repository }}/compare/${latest_tag}...v${{ steps.branch_info.outputs.final_version }}"
          fi
          # 将处理后的内容写入 GITHUB_OUTPUT
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$changelog_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build with Gradle
        # 仅在标签不存在时执行
        if: steps.check_tag.outputs.skip == 'false'
        run: ./gradlew assembleRelease -PappVersionName=${{ steps.branch_info.outputs.final_version }}

      - name: Create Git Tag and Release
        # 仅在标签不存在时执行
        if: steps.check_tag.outputs.skip == 'false'
        run: |
          # 手动创建 tag，确保指向当前 HEAD（master 分支的最新 commit）
          git tag "v${{ steps.branch_info.outputs.final_version }}"
          git push origin "v${{ steps.branch_info.outputs.final_version }}"

      - name: Create GitHub Release
        # 仅在标签不存在时执行
        if: steps.check_tag.outputs.skip == 'false'
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: app/build/outputs/apk/release/app-release.apk
          # 使用我们生成的更新日志作为 Release 的 body
          body: ${{ steps.changelog.outputs.changelog }}
          # 使用我们生成的版本号来创建 Release 和 Tag
          tag_name: "v${{ steps.branch_info.outputs.final_version }}"
          name: "Release v${{ steps.branch_info.outputs.final_version }}"