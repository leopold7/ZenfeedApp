# GitHub Actions 工作流：dev 分支自动 Release
name: Create Dev Release

on:
  push:
    branches:
      - dev    # 当向 dev 分支推送代码时触发

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    # 为工作流授予向仓库写入内容的权限，以便能推送 Git 标签
    permissions:
      contents: write
    env:
      TZ: Asia/Shanghai # 设置时区为东八区
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # 拉取所有历史记录，以便能正确生成更新日志
        with:
          fetch-depth: 0
          ref: dev

      - name: Debug: Show Git info
        run: |
          echo "=== Current branch ==="
          git branch --show-current
          echo ""
          echo "=== Current commit ==="
          git rev-parse HEAD
          echo ""
          echo "=== Latest commits on dev ==="
          git log dev --oneline -5
          echo ""
          echo "=== Remote branches ==="
          git branch -r

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Decode Keystore and write to file
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE }}" | base64 --decode > ${{ github.workspace }}/app/mykey

      - name: Create local.properties file
        run: |
          echo "keystore.file=${{ github.workspace }}/app/mykey" >> local.properties
          echo "keystore.password=${{ secrets.RELEASE_KEYSTORE_PASSWORD }}" >> local.properties
          echo "key.alias=${{ secrets.RELEASE_KEY_ALIAS }}" >> local.properties
          echo "key.password=${{ secrets.RELEASE_KEY_PASSWORD }}" >> local.properties

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Determine dev version information
        id: branch_info
        run: |
          # 读取版本名称
          versionName=$(grep 'appVersionName' gradle.properties | cut -d'=' -f2)
          echo "base_version=$versionName" >> $GITHUB_OUTPUT
          
          # 生成时间戳
          timestamp=$(date +'%Y%m%d%H%M%S')
          echo "timestamp=$timestamp" >> $GITHUB_OUTPUT
          
          # 为dev分支生成特殊版本号
          dev_version="${versionName}.dev.${timestamp}"
          echo "final_version=$dev_version" >> $GITHUB_OUTPUT

      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.branch_info.outputs.final_version }}" >/dev/null 2>&1; then
            echo "Tag v${{ steps.branch_info.outputs.final_version }} already exists. No new release needed."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Tag v${{ steps.branch_info.outputs.final_version }} does not exist. Proceeding with release."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Changelog
        # 仅在标签不存在时执行
        if: steps.check_tag.outputs.skip == 'false'
        id: changelog
        run: |
          # dev分支：查找最新的稳定版本标签（不以 dev 结尾）
          latest_tag=$(git tag -l "v*" --sort=-version:refname | grep -v "dev" | head -n 1)
          
          if [ -z "$latest_tag" ]; then
            # 如果没有上一个标签，就从第一次提交开始计算
            changelog_content=$(git log --grep="^feat\|^fix\|^style\|^refactor" --pretty=format:"* %h %s")
          else
            # 如果有上一个标签，就计算两个标签之间的提交
            changelog_content=$(git log ${latest_tag}..HEAD --grep="^feat\|^fix\|^style\|^refactor" --pretty=format:"* %h %s")
          fi
          # 添加 Full Changelog 链接
          if [ -n "$latest_tag" ]; then
            changelog_content="${changelog_content}"$'\n'$'\n'"**Full Changelog**: https://github.com/${{ github.repository }}/compare/${latest_tag}...v${{ steps.branch_info.outputs.final_version }}"
          fi
          # 将处理后的内容写入 GITHUB_OUTPUT
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$changelog_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build with Gradle
        # 仅在标签不存在时执行
        if: steps.check_tag.outputs.skip == 'false'
        run: ./gradlew assembleRelease -PappVersionName=${{ steps.branch_info.outputs.final_version }}

      - name: Delete old dev releases
        # 仅在标签不存在时执行
        if: steps.check_tag.outputs.skip == 'false'
        run: |
          # 获取所有发布版本
          releases=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/releases)
          
          # 过滤出dev版本并删除
          echo "$releases" | jq -r '.[] | select(.tag_name | test("dev")) | .id' | while read -r release_id; do
            echo "Deleting old dev release: $release_id"
            curl -s -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/releases/$release_id
          done

      - name: Delete old dev tags
        # 仅在标签不存在时执行
        if: steps.check_tag.outputs.skip == 'false'
        run: |
          # 列出所有包含 "dev" 的标签
          dev_tags=$(git tag -l "*dev*")
          
          # 遍历并删除这些标签
          if [ -n "$dev_tags" ]; then
            echo "Deleting old dev tags:"
            echo "$dev_tags" | while read -r tag; do
              echo "Deleting tag: $tag"
              git tag -d "$tag"
              git push origin --delete "$tag"
            done
          else
            echo "No dev tags found to delete"
          fi

      - name: Create Git Tag and Release
        # 仅在标签不存在时执行
        if: steps.check_tag.outputs.skip == 'false'
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: app/build/outputs/apk/release/app-release.apk
          # 使用我们生成的更新日志作为 Release 的 body
          body: ${{ steps.changelog.outputs.changelog }}
          # 使用我们生成的版本号来创建 Release 和 Tag
          tag_name: "v${{ steps.branch_info.outputs.final_version }}"
          name: "Dev Release v${{ steps.branch_info.outputs.final_version }}"
          # dev分支设置为预发布
          prerelease: true
